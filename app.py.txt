from flask import Flask
from google.oauth2.service_account import Credentials
import gspread
import os, json, requests, threading, time
from bs4 import BeautifulSoup

app = Flask(__name__)

# === 環境変数 ===
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
SHEET_ID = os.getenv("SHEET_ID")
CREDENTIALS_JSON = os.getenv("CREDENTIALS_JSON")

# === Google Sheets 接続 ===
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = Credentials.from_service_account_info(json.loads(CREDENTIALS_JSON), scopes=scope)
client = gspread.authorize(creds)
sheet = client.open_by_key(SHEET_ID).sheet1

# === 削除検知用ヘッダー ===
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                  "AppleWebKit/537.36 (KHTML, like Gecko) "
                  "Chrome/114.0.0.0 Safari/537.36"
}

# === Discord通知 ===
def notify_discord(message):
    if WEBHOOK_URL:
        requests.post(WEBHOOK_URL, json={"content": message})

# === 新規行追加検知 ===
def check_spreadsheet():
    print("📊 スプレッドシート監視スレッド開始（新規行検知 & 削除チェック）")
    last_row = None
    while True:
        try:
            data = sheet.get_all_values()
            if not data:
                time.sleep(30)
                continue

            if data[-1] != last_row:
                last_row = data[-1]
                message = f"✅ 新しい行が追加されました: {' | '.join(last_row)}"
                print(message)
                notify_discord(message)
        except Exception as e:
            print(f"⚠️ スプレッドシート取得エラー: {e}")
        time.sleep(30)

# === メルカリ商品削除チェック ===
def check_deleted_items():
    print("🕵️ メルカリ商品削除検知スレッド開始")
    while True:
        try:
            data = sheet.get_all_values()
            urls = [row[0] for row in data[1:] if row and row[0].startswith("http")]
            for url in urls:
                try:
                    res = requests.get(url, headers=headers)
                    print(f"🔎 {url} → {res.status_code}")
                    if res.status_code == 404 or "この商品は削除されました" in res.text:
                        notify_discord(f"❌ 商品削除検知: {url}")
                except Exception as e:
                    print(f"⚠️ URL取得エラー: {e}")
            time.sleep(300)  # 5分ごとにチェック
        except Exception as e:
            print(f"⚠️ 削除検知スレッドエラー: {e}")
            time.sleep(60)

@app.route('/')
def home():
    return "Bot is running and watching Google Sheets."

def run_checker():
    threading.Thread(target=check_spreadsheet, daemon=True).start()
    threading.Thread(target=check_deleted_items, daemon=True).start()
    print("🤖 Bot起動完了・監視スレッドを開始しました")

if __name__ == '__main__':
    notify_discord("✅ Render起動テスト通知（再起動検知）")
    run_checker()
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 10000)))