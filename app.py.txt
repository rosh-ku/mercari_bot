from flask import Flask
from google.oauth2.service_account import Credentials
import gspread
import os, json, requests, threading, time
from bs4 import BeautifulSoup

app = Flask(__name__)

# === ç’°å¢ƒå¤‰æ•° ===
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
SHEET_ID = os.getenv("SHEET_ID")
CREDENTIALS_JSON = os.getenv("CREDENTIALS_JSON")

# === Google Sheets æ¥ç¶š ===
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = Credentials.from_service_account_info(json.loads(CREDENTIALS_JSON), scopes=scope)
client = gspread.authorize(creds)
sheet = client.open_by_key(SHEET_ID).sheet1

# === å‰Šé™¤æ¤œçŸ¥ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ ===
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                  "AppleWebKit/537.36 (KHTML, like Gecko) "
                  "Chrome/114.0.0.0 Safari/537.36"
}

# === Discordé€šçŸ¥ ===
def notify_discord(message):
    if WEBHOOK_URL:
        requests.post(WEBHOOK_URL, json={"content": message})

# === æ–°è¦è¡Œè¿½åŠ æ¤œçŸ¥ ===
def check_spreadsheet():
    print("ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç›£è¦–ã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹ï¼ˆæ–°è¦è¡Œæ¤œçŸ¥ & å‰Šé™¤ãƒã‚§ãƒƒã‚¯ï¼‰")
    last_row = None
    while True:
        try:
            data = sheet.get_all_values()
            if not data:
                time.sleep(30)
                continue

            if data[-1] != last_row:
                last_row = data[-1]
                message = f"âœ… æ–°ã—ã„è¡ŒãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ: {' | '.join(last_row)}"
                print(message)
                notify_discord(message)
        except Exception as e:
            print(f"âš ï¸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        time.sleep(30)

# === ãƒ¡ãƒ«ã‚«ãƒªå•†å“å‰Šé™¤ãƒã‚§ãƒƒã‚¯ ===
def check_deleted_items():
    print("ğŸ•µï¸ ãƒ¡ãƒ«ã‚«ãƒªå•†å“å‰Šé™¤æ¤œçŸ¥ã‚¹ãƒ¬ãƒƒãƒ‰é–‹å§‹")
    while True:
        try:
            data = sheet.get_all_values()
            urls = [row[0] for row in data[1:] if row and row[0].startswith("http")]
            for url in urls:
                try:
                    res = requests.get(url, headers=headers)
                    print(f"ğŸ” {url} â†’ {res.status_code}")
                    if res.status_code == 404 or "ã“ã®å•†å“ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ" in res.text:
                        notify_discord(f"âŒ å•†å“å‰Šé™¤æ¤œçŸ¥: {url}")
                except Exception as e:
                    print(f"âš ï¸ URLå–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            time.sleep(300)  # 5åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        except Exception as e:
            print(f"âš ï¸ å‰Šé™¤æ¤œçŸ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¨ãƒ©ãƒ¼: {e}")
            time.sleep(60)

@app.route('/')
def home():
    return "Bot is running and watching Google Sheets."

def run_checker():
    threading.Thread(target=check_spreadsheet, daemon=True).start()
    threading.Thread(target=check_deleted_items, daemon=True).start()
    print("ğŸ¤– Botèµ·å‹•å®Œäº†ãƒ»ç›£è¦–ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ")

if __name__ == '__main__':
    notify_discord("âœ… Renderèµ·å‹•ãƒ†ã‚¹ãƒˆé€šçŸ¥ï¼ˆå†èµ·å‹•æ¤œçŸ¥ï¼‰")
    run_checker()
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 10000)))