from flask import Flask
import os, json, requests, threading, time, re
import gspread
from google.oauth2.service_account import Credentials
from bs4 import BeautifulSoup
from datetime import datetime, timezone, timedelta

app = Flask(__name__)

# ==== ç’°å¢ƒå¤‰æ•° ====
WEBHOOK_URL = os.getenv("WEBHOOK_URL")
SHEET_ID = os.getenv("SHEET_ID")
CREDENTIALS_JSON = json.loads(os.getenv("CREDENTIALS_JSON"))

# ==== Google Sheetsèªè¨¼ ====
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = Credentials.from_service_account_info(CREDENTIALS_JSON, scopes=scope)
client = gspread.authorize(creds)
sheet = client.open_by_key(SHEET_ID).sheet1

# ==== Discordé€šçŸ¥ ====
def send_discord_message(content):
    try:
        res = requests.post(WEBHOOK_URL, json={"content": content})
        print(f"Discordé€šçŸ¥é€ä¿¡: {res.status_code}")
    except Exception as e:
        print(f"Discordé€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")

# ==== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç›£è¦– ====
def check_spreadsheet():
    print("ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç›£è¦–é–‹å§‹")
    last_row = None
    while True:
        try:
            data = sheet.get_all_values()
            if not data:
                continue
            new_row = data[-1]
            if new_row != last_row:
                last_row = new_row
                message = f"âœ… æ–°ã—ã„è¡ŒãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ: {' | '.join(new_row)}"
                send_discord_message(message)
        except Exception as e:
            print(f"âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {e}")
        time.sleep(30)

# ==== ãƒ¡ãƒ«ã‚«ãƒªURLç›£è¦–ï¼ˆå‰Šé™¤ãƒ»éå…¬é–‹æ¤œçŸ¥ï¼‰ ====
def check_mercari_urls():
    print("ğŸ•µï¸ ãƒ¡ãƒ«ã‚«ãƒªURLç›£è¦–é–‹å§‹ï¼ˆå•†å“åï¼†å‰Šé™¤æ—¥æ™‚å¯¾å¿œï¼‰")
    checked_urls = {}

    while True:
        try:
            # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            data = sheet.get_all_values()
            text = "\n".join([" ".join(row) for row in data])
            urls = re.findall(r"https?://jp\.mercari\.com/item/[A-Za-z0-9]+", text)

            for url in urls:
                try:
                    res = requests.get(url, timeout=10)
                    if res.status_code == 200:
                        # å•†å“åã‚’å–å¾—
                        soup = BeautifulSoup(res.text, "html.parser")
                        title_tag = soup.find("title")
                        title = title_tag.text.replace("ãƒ¡ãƒ«ã‚«ãƒª", "").strip() if title_tag else "ä¸æ˜ãªå•†å“"
                        checked_urls[url] = title
                    else:
                        if url not in checked_urls:
                            checked_urls[url] = "å•†å“åä¸æ˜"

                        # æ—¥æœ¬æ™‚é–“ã§å‰Šé™¤æ¤œçŸ¥æ™‚åˆ»ã‚’è¨˜éŒ²
                        JST = timezone(timedelta(hours=9))
                        now = datetime.now(JST).strftime("%Y-%m-%d %H:%M:%S")

                        send_discord_message(
                            f"âŒ ãƒ¡ãƒ«ã‚«ãƒªå•†å“ãŒå‰Šé™¤ã¾ãŸã¯éå…¬é–‹ã«ãªã‚Šã¾ã—ãŸ:\n"
                            f"ğŸ•’ å‰Šé™¤æ¤œçŸ¥: {now}\n"
                            f"ğŸ“¦ å•†å“å: {checked_urls[url]}\n"
                            f"ğŸ”— URL: {url}"
                        )
                except Exception as e:
                    print(f"âš ï¸ URLãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: {url} - {e}")

            time.sleep(1800)  # 30åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        except Exception as e:
            print(f"âš ï¸ ãƒ¡ãƒ«ã‚«ãƒªç›£è¦–ãƒ«ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼: {e}")
            time.sleep(60)

@app.route('/')
def home():
    return "Bot is running and watching Google Sheets & Mercari."

# ==== ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ ====
if __name__ == "__main__":
    print("ğŸš€ Botèµ·å‹•ä¸­...")
    send_discord_message("âœ… Renderèµ·å‹•ãƒ†ã‚¹ãƒˆé€šçŸ¥ï¼ˆå†èµ·å‹•æ¤œçŸ¥ï¼‰")

    # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç›£è¦–ã‚¹ãƒ¬ãƒƒãƒ‰
    threading.Thread(target=check_spreadsheet, daemon=True).start()

    # ãƒ¡ãƒ«ã‚«ãƒªURLç›£è¦–ã‚¹ãƒ¬ãƒƒãƒ‰
    threading.Thread(target=check_mercari_urls, daemon=True).start()

    print("ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼†ãƒ¡ãƒ«ã‚«ãƒªç›£è¦–ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ")
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))